import subprocess
import pandas as pd
import socket
improt openpyxl

def get_yum_list():
    # subprocessでyumコマンド実行
    result = subprocess.run(['yum', 'list', 'installed'], stdout=subprocess.PIPE, text=True)
    lines = result.stdout.splitlines()

    # 表の開始位置を見つける（"Installed Packages" の行を基準にする）
    start_index = next((i for i, line in enumerate(lines) if "Installed Packages" in line), None)
    if start_index is None:
        raise ValueError("Installed Packages not found in yum output")

    # データ部分を抽出し、パッケージ名にバージョンを組み込む
    package_data = []
    for line in lines[start_index + 1:]:
        columns = line.split()
        if len(columns) >= 3:
            package_name = columns[0]  # パッケージ名
            version = columns[1]      # バージョン
            modified_package_name = f"{package_name}-{version.split('-')[0]}"  # バージョンを組み込む
            package_data.append({
                'Package': modified_package_name,
                'Version': columns[1],
                'Repository': columns[2]
            })

    # DataFrameに変換
    df = pd.DataFrame(package_data)
    return df

def save_to_excel(df):
    # ホスト名を取得
    hostname = socket.gethostname()
    # ファイル名にホスト名を組み込む
    file_name = f"yum_list_installed_{hostname}.xlsx"
    # Excelファイルに保存
    df.to_excel(file_name, index=False)
    return file_name

if __name__ == "__main__":
    df = get_yum_list()
    excel_file = save_to_excel(df)
    print(f"Excel file saved: {excel_file}")