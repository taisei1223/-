#!/bin/bash

# ==========================
# è¨­å®šï¼ˆé©å®œå¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
# ==========================
PFX_FILE="cert.pfx"  # å…¥åŠ›ã™ã‚‹ PFX ãƒ•ã‚¡ã‚¤ãƒ«
PFX_PASSWORD="pfxpassword"  # PFX ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
TRUSTSTORE_PASSWORD="truststorepassword"  # truststore.jks ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
KEYSTORE_PASSWORD="keystorepassword"  # keystore.jks ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
KEY_ALIAS="mycert"  # ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹å

# ==========================
# PFX ã‹ã‚‰è¨¼æ˜æ›¸ãƒ»ç§˜å¯†éµã‚’æŠ½å‡º
# ==========================
echo "ğŸ”¹ PFX ã‹ã‚‰è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’æŠ½å‡ºä¸­..."
openssl pkcs12 -in $PFX_FILE -nocerts -nodes -out private.key -password pass:$PFX_PASSWORD
openssl pkcs12 -in $PFX_FILE -clcerts -nokeys -out cert.pem -password pass:$PFX_PASSWORD
openssl pkcs12 -in $PFX_FILE -cacerts -nokeys -out ca.pem -password pass:$PFX_PASSWORD

# ==========================
# truststore.jks ã‚’ä½œæˆ
# ==========================
echo "ğŸ”¹ truststore.jks ã‚’ä½œæˆä¸­..."
keytool -importcert -alias rootCA -file ca.pem -keystore truststore.jks -storepass $TRUSTSTORE_PASSWORD -noprompt

# ==========================
# PKCS12 ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
# ==========================
echo "ğŸ”¹ keystore.p12 ã‚’ä½œæˆä¸­..."
openssl pkcs12 -export -in cert.pem -inkey private.key -certfile ca.pem -out keystore.p12 -name $KEY_ALIAS -password pass:$KEYSTORE_PASSWORD

# ==========================
# keystore.jks ã«å¤‰æ›
# ==========================
echo "ğŸ”¹ keystore.jks ã‚’ä½œæˆä¸­..."
keytool -importkeystore -srckeystore keystore.p12 -srcstoretype PKCS12 -destkeystore keystore.jks -deststoretype JKS -srcstorepass $KEYSTORE_PASSWORD -deststorepass $KEYSTORE_PASSWORD -alias $KEY_ALIAS

# ==========================
# JKS ã®å†…å®¹ç¢ºèª
# ==========================
echo "ğŸ”¹ truststore.jks ã®å†…å®¹:"
keytool -list -keystore truststore.jks -storepass $TRUSTSTORE_PASSWORD

echo "ğŸ”¹ keystore.jks ã®å†…å®¹:"
keytool -list -keystore keystore.jks -storepass $KEYSTORE_PASSWORD

echo "âœ… å¤‰æ›å®Œäº†ï¼"